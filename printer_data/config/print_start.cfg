[gcode_macro START_PRINT]
gcode:
    {% set PROBE_TEMP = 150 %}
	{% set BED_TEMP=params.BED_TEMP|default(60)|float %}
	{% set EXTRUDER_TEMP=params.EXTRUDER_TEMP|default(150)|float %}
	
	# Enables part cooling fan to stop duct from melting when waiting for bed temp
	M106 S153
	
	# Home the printer
	STATUS_HOMING
    G90
	M83
	G28

    # Preheat the nozzle for TAP
    STATUS_HEATING
    M104 S{PROBE_TEMP}
    
	# Preheat the bed
	STATUS_HEATING
   	M190 S{BED_TEMP}
	
    

    # Performe TAP
    STATUS_CALIBRATING_Z
    PROBE_EDDY_NG_TAP
    
	# Bed Mesh
	STATUS_MESHING
    BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1
		
	# Heat the extruder to the desired temperature
	STATUS_HEATING
    G1 Z20 F3000 ; mone nozzle away from bed
    G1 X5 Y5 F1500 ; move to prime position
   	M109 S{EXTRUDER_TEMP}
	
	# Prime line sequence
	STATUS_BUSY
    G1 Z0.15 F3000 ; get ready to prime
	G92 E0 ; reset extrusion distance
	G1 Y100 E30 F600 ; prime nozzle with adjusted extrusion / E__ based on how much you like
	
	# String removal circle after priming
	G1 Z0.2 F3000 ; adjust to 0.2mm above the bed
	

[gcode_macro PRINT_END]
gcode:
  STATUS_OFF  ;Status off
  G1 E-5 F1800  ;Retract filament
  _MOVE_AWAY  ;Move away from print
  PARK_CENTER_REAR  ;Park central rear
  TURN_OFF_HEATERS  ;Turn off heaters
  BED_MESH_CLEAR  ;Clear Bed Mesh
  PROBE_EDDY_NG_SET_TAP_OFFSET VALUE=0

[gcode_macro _MOVE_AWAY]
gcode:
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 20, th.axis_maximum.z]|min %}
      
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing


[gcode_macro PARK_CENTER_REAR]
gcode:
    {% if printer["gcode_macro status_busy"] != null %}
      status_busy
    {% endif %}
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}

    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  
    {% if printer["gcode_macro status_ready"] != null %}
    status_ready
    {% endif %}

    